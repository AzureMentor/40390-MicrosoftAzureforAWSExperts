# Lab Answer Key:  Module 3: Linux in Azure
## Lab 1: Creating and Connecting to a Linux Virtual Machine
  
Lab Steps

- Install Git for Windows
- Create cryptographic keys
- Create a Linux virtual machine by using the Azure portal
- Connect to the Linux virtual machine by using the PuTTY utility

Please note that the virtual machine that you will create in this lab will also be used in the next lab of this course. 

### Exercise 1: Creating Cryptographic Keys
  
Scenario: In this exercise you will create cryptographic keys that you will use to connect via PuTTY to the Azure virtual machine that you deploy later in this lab.

The main tasks for this exercise are as follows:

1. Install Git for Windows

2. Create a key pair

3. Create a private key for PuTTY

#### Task 1: Install Git for Windows


1. Start Internet Explorer and browse to https://git-for-windows.github.io/ 

2. Click on the **Download** link.

3. When prompted whether to run or save the Git executable, click **Run**.

4. In the Git 2.11.0 Setup wizard, accept the default settings and complete the install.

5. Once the install completes, on the **Completing the Git Setup Wizard** page, select the **Launch Git Bash** checkbox and click **Finish**. Alternatively, from the Start menu (or screen), start **Git Bash**.

#### Task 2: Create a key pair

1. In the **Git Bash window**, run the following:

  ```
openssl.exe req -x509 -nodes -days 365 -newkey rsa:2048 \
     -keyout myPrivateKey.key -out myCert.pem
  ```

2. When prompted, provide the information to be incorporated into the certificate you are generating, including country code, state or province, locality name, organization name, organizational unit, common name, and email address (for the purpose of this lab, you can use made up values).

3. Generate a public key by running:

  ```
openssl.exe rsa -pubout -in myPrivateKey.key -out myPublicKey.key
  ```

#### Task 3: Create a private key for PuTTY

1. Convert the private key you generated in the previous task into a private key that you will be able to use with the PuTTY utility. In the **Git Bash** window, run the following:

  ```
openssl rsa -in ./myPrivateKey.key -out myPrivateKey_rsa
  ```
 
2. Download PuTTYgen from http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html to the C:\Users\username folder, where username is your Windows user account name. This is the same location where the keys you generated in the previous task reside. 

3. In the File Explorer window, double-click **puttygen.exe**.

4. In the **PuTTY Key Generator** window, click **Load**.

5. In the **Load private key** dialog box, change the filter to **All Files (*.*)**, select **myPrivateKey_rsa** and click **Open**.

6. In the **PuTTYgen Notice** dialog box, click **OK**.

7. Copy the entire content of the **Public key for pasting into OpenSSH authorized_key file** section of the **PuTTY Key Generator** window into Clipboard.

8. In the **PuTTY Key Generator** window, click **Save private key**

9. Save the private key as **myPrivateKey_rsa.ppk** in the C:\Users\username directory (where username is your Windows user name). Click **Yes** in the **PuTTYgen Warning** dialog box, when prompted whether to save the key without a passphrase to protect it. Note that you have the option of protecting it with a passphrase.

Note: Outside of a lab environment, you should use a passphrase and file system permission to protect your private key.

### Exercise 2: Create and connect to a Linux virtual machine

Scenario: In this exercise you will create a new Linux virtual machine by using the Azure portal and use the key you generated to connect to it.

The main tasks for this exercise are as follows:

1. Create a new Linux virtual machine by using the Azure portal

2. Connect to the Linux virtual machine by using PuTTY


#### Task 1: Create a new virtual machine
 
1. Start Internet Explorer and browse to https://portal.azure.com 

2. Click on the **+New** link.

3. Select Compute in the blade that comes up.

4. In the Compute blade select **See all**.

5. In the Filter text box, type **Ubuntu Server** and press **Enter**

6. In the list of results, click the latest recommended version of the Ubuntu Server.

7. Ensure that the deployment type is set to Resource Manager and click **Create**.

8. On the Basics blade, specify the following and click **OK**.
 
-  Name: **LABLinuxVM**
 
-  VM disk type: **HDD**
 
-  User name: **Student**
 
-  Authentication type: **SSH public key**
 
-  SSH public key: paste the content of Clipboard
 
-  Resource group: create a new resource group called **LABLinuxRG**
 
-  Location: an Azure region closest to your physical location

9. On the Choose a size blade, click **DS1_V2** size and click **Select**.

10. On the **Settings** blade, accept the default settings and click **OK**.

11. On the **Summary** page, click **OK**

#### Task 2: Connect to the Linux virtual machine by using PuTTY

**Note**: You need to wait until the new virtual machine has been provisioned. This should take a couple of minutes. The Azure portal will automatically display the new blade showing the settings of the new virtual machine.

1. In the Azure portal, in the Overview section of the LABLinuxVM blade, note the Public IP address assigned to the VM

2. Start Internet Explorer and browse to http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html

3. Download putty.exe to your computer and click **Run** when prompted.

4. In the **PuTTY Configuration** window, type the IP address you noted in step 1 in the **Host Name (or IP address)** text box.

5. In the **Category** section of the **PuTTY Configuration** window, expand the **Connection->SSH->Auth** nodes.

6. Click **Browse** next to the **Private key file for authentication** text box.

7. In the **Select private key file** dialog box, navigate to the C:\Users\username directory (where username is your Windows user name), select **myPrivateKey_rsa.ppk** and click **Open**.

8. When prompted by the **PuTTY Security Alert**, click **Yes**.

9. In the **PuTTY** window, when prompted for the username, type in **Student** and verify that you have successfully authenticated.


## Lab 2: Configuring Linux Azure Virtual Machine Storage

To do this lab you'll need the following:
- Microsoft Azure Subscription: http://azure.microsoft.com/en-us/pricing/free-trial/ 
- Client computer with Internet connectivity.
- An existing Linux Ubuntu Azure virtual machine (created in previous lab)

Lab Steps

- Add virtual disks to an Azure VM
- Configure newly added disks in a RAID stripe set within an Azure Linux VM


### Exercise 1: Add virtual disks to an Linux VM

In this exercise you will add virtual disks to an Linux VM by using the Azure portal

The main tasks for this exercise are as follows:

1. Log in to the Azure portal

2. Add virtual disks to an Azure


#### Task 1: Log in to the Azure portal
 
1. Start Internet Explorer and browse to Start Internet Explorer and browse to https://portal.azure.com 

2. If prompted, sign in with your Microsoft account that is either the Service Admin or a Co-Administrator of your Azure subscription.


#### Task 2: Add virtual disks to an Azure

1. In the Azure portal, browse to **Virtual machines**.

2. In the list of virtual machines, click **LABLinuxVM**.

3. On the **LABLinuxVM** blade, click **Disks**.

4. On the **LABLinuxVM – Disks** blade, click **Attach new**.

5. On the **Attach new disk** blade, make sure that the type of the disk is set to **HDD**, accept all remaining default settings, and click **Location**.

6. On the **Storage accounts** blade, click **+ Storage account**.

7. On the **Create storage account** blade, specify the following settings and click **OK**:

- Name: any unique name between 3 and 24 characters in length, consisting of a combination of lower case letters and digits
- Performance: **Standard**
- Replication: **Locally-redundant storage (LRS)**

8. Back on the **Storage accounts** blade, click the newly created storage account.

9. On the **Containers** blade, click **+ Container**.

10. On the **New container** blade, specify the following and click **Create**:

- Name: **vhds**
- Access type: **Private**

11. Back on the **Containers** blade, ensure that **vhds** is selected and click **Select**. 

12. Back on the **Attach new disk** blade, click **OK**. Wait until you receive a confirmation that the disk was created. This should take less than a minute.

13. On the **LABLinuxVM – Disks** blade, click **Attach new**.

14. On the **Attach new** disk blade, change the type of the disk to **HDD**, accept all remaining default settings, and click **Location**.

15. On the **Storage accounts** blade, click the newly created storage account.

16. On the **Containers** blade, click **vhds** and click **Select**.

17. Back on the **Attach new disk** blade, click **OK**. Wait until you receive a confirmation that the disk was created. This should take less than a minute.


### Exercise 2: Create a RAID stripe set within an Azure Linux VM

In this exercise you will configure newly added disks in a RAID stripe set within an Azure Linux VM.

The main tasks for this exercise are as follows:　

1. Connect to the Azure Linux VM by using PuTTY

2. Configure RAID stripe set within the Azure Linux VM


#### Task 1: Connect to the Azure Linux VM

Note: If you are already connected to the Linux VM (continuing from the previous lab), skip this task.

1. In the Azure portal, in the Overview section of the **LABLinuxVM** blade, note the Public IP address assigned to the VM

2. Start **putty.exe** you downloaded in the previous lab.

3. In the **PuTTY Configuration** window, type the IP address you noted in step 1 in the **Host Name (or IP address)** text box.

4. In the **Category** section of the **PuTTY Configuration** window, expand **Connection->SSH->Auth** nodes.

5. Click **Browse** next to the **Private key file for authentication** text box.

6. In the **Select private key** file dialog box, navigate to the C:\Users\username directory (where username is your Windows user name), select myPrivateKey_rsa.ppk and click **Open**.

7. If prompted by the **PuTTY Security Alert**, click **Yes**.

8. In the **PuTTY** window, when prompted for the username, type **Student** and verify that you have successfully authenticated.


#### Task 2: Configure a RAID stripe set within the Azure Linux VM

1. In the PuTTY window, run the following to elevate your privileges to root:

  ```
sudo su -
  ```

2. Next, run the following to download updates necessary to manage RAID configuration:

  ```
apt-get update
apt-get install mdadm
  ```

3. Next, run the following to examine SCSI disk operations:

  ```
grep SCSI /var/log/syslog
  ```

4. Examine the results and locate the entries representing the disks you added in the previous exercise. They should resemble the following:

  ```
Dec  3 11:04:33 LABLinuxVM kernel: [ 1268.731453] sd 5:0:0:0: [sdc] Attached SCSI disk
Dec  3 11:06:58 LABLinuxVM kernel: [ 1414.415135] sd 5:0:0:1: [sdd] Attached SCSI disk
  ```

5. Create disk partitions for the first disk by running the following:

  ```
fdisk /dev/sdc 
  ```

6. When prompted, use the following sequence of steps:

  ``` 
type n
type p
type 1
press <Enter>
press <Enter>
type t
type fd
type w
  ```

7. The output should resemble the following:

  ```
root@LABLinuxVM:~# fdisk /dev/sdc
Welcome to fdisk (util-linux 2.27.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.
Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x59132ebb.
Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 1
First sector (2048-2145386495, default 2048):
Last sector, +sectors or +size{K,M,G,T,P} (2048-2145386495, default 2145386495):
Created a new partition 1 of type 'Linux' and of size 1023 GiB.
Command (m for help): t
Selected partition 1
Partition type (type L to list all types): 1
Changed type of partition 'Linux' to 'FAT12'.
Command (m for help): fd
f: unknown command
Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
root@LABLinuxVM:~#
  ```
 
8. Now repeat the same sequence of steps for the second disk. Create disk partitions for the second disk by running the following:

  ``` 
fdisk /dev/sdd
  ```

9. When prompted, use the following sequence of steps:

  ``` 
type n
type p
type 1
press <Enter>
press <Enter>
type t
type fd
type w
  ```

10. The output should resemble the following:

  ```
root@LABLinuxVM:~# fdisk /dev/sdd
Welcome to fdisk (util-linux 2.27.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.
Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0xbbd08528.
Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 1
First sector (2048-2145386495, default 2048):
Last sector, +sectors or +size{K,M,G,T,P} (2048-2145386495, default 2145386495):
Created a new partition 1 of type 'Linux' and of size 1023 GiB.
Command (m for help): t
Selected partition 1
Partition type (type L to list all types): fd
Changed type of partition 'Linux' to 'Linux raid autodetect'.
Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
root@LABLinuxVM:~#
  ```

11. Create a RAID stripe set consisting of the two disk partitions by running the following:

  ```
mdadm --create /dev/md127 --level 0 --raid-devices 2 /dev/sdc /dev/sdd 
  ```

12. When prompted whether to continue creating array, type:

  ``` 
y
  ```

13. Create the file system on the new RAID stripe set by running the following:

  ``` 
mkfs -t ext4 /dev/md127 
  ```

14. To add the new file system, start by creating a mount point called data. To accomplish this run the following:

  ``` 
mkdir /data 
  ```

15. To mount the new RAID stripe set, you also need to identify the UUID of the file system you created. To accomplish this run the following:

  ```
/sbin/blkid 
  ```

16. Examine the output and identify the UUID value of the /dev/md127 entry. It should resemble the following:

  ```
root@LABLinuxVM:~# /sbin/blkid
/dev/sda1: LABEL="cloudimg-rootfs" UUID="e990f8b3-1d6b-4615-8280-8ead4ed2fe7c" TYPE="ext4" PARTUUID="2865a230-01"
/dev/sdb1: LABEL="Temporary Storage" UUID="00C40FB2C40FA94C" TYPE="ntfs" PARTUUID="e08453a8-01"
/dev/sdc1: PARTUUID="59132ebb-01"
/dev/sdd1: PARTUUID="bbd08528-01"
/dev/md127: UUID="b6b3c061-06e4-48ed-86a9-cd87e0a6f59e" TYPE="ext4"
  ```
 
Note: The UUID value in your case will be different. Make sure to use that value in the next step.
 
17. To mount the new file system, add an entry referencing this UUID to the /etc/fstab file. To accomplish this, run the following: 

  ```
echo UUID=b6b3c061-06e4-48ed-86a9-cd87e0a6f59e /data ext4 defaults 0 2 >> /etc/fstab
  ```

18. To verify that the new entry in /etc/fstab file is correct, run the following and make sure that no error messages being displayed: 

  ```
mount -a
  ```

19. To mount the file system, run the following: 

  ```
mount
  ```

20. Verify that the output includes the entry that looks as follows:

  ```
/dev/md127 on /data type ext4 (rw,relatime,stripe=256,data=ordered)
  ```

21. To test the results, run:

  ```
df
  ```

22. The output should resemble the following:

  ``` 
root@LABLinuxVM:/data# df
Filesystem      1K-blocks    Used  Available Use% Mounted on
udev               964696       0     964696   0% /dev
tmpfs              197236    5900     191336   3% /run
/dev/sda1        29595200 1514084   28064732   6% /
tmpfs              986168       0     986168   0% /dev/shm
tmpfs                5120       0       5120   0% /run/lock
tmpfs              986168       0     986168   0% /sys/fs/cgroup
/dev/sda15         106858    3607     103251   4% /boot/efi
/dev/sdb1         4061824   16380    3819400   1% /mnt
tmpfs              197232       0     197232   0% /run/user/1000
/dev/md127     2110406720   81948 2003052172   1% /data
  ```

Note: After completing the lab, stop the Azure VM from the Azure portal to avoid compute charges.